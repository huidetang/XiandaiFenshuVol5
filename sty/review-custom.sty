% for user-defined macro
\usepackage{niceframe}

\jlreqsetup{endnote_position={_chapter}}

\renewcommand{\reviewbibref}[2]{\cite{#2}}

\if@tate
  \def\recls@tmp{uplatex}\ifx\recls@tmp\recls@engine
    \RequirePackage{plext}
  \fi
  \def\recls@tmp{lualatex}\ifx\recls@tmp\recls@engine
    \RequirePackage{lltjext}
  \fi
  \jlreqsetup{frontmatter_pagebreak={}}% これを入れないと大扉前に白が入る
\fi

\if@reclscover
  \ifdefined\review@coverimage
    \ifrecls@coverfitpage
       \def\review@coverimageoption{width=\paperwidth,height=\paperheight}
    \fi
    \def\reviewcoverpagecont{%
      \if@tate
        \expandafter\includefullpagegraphics\expandafter[angle=90,\review@coverimageoption]{\review@coverimage}
      \else
        \expandafter\includefullpagegraphics\expandafter[\review@coverimageoption]{\review@coverimage}
      \fi
      \cleardoublepage
    }
  \fi
  \ifdefined\review@coverfile
    \def\reviewcoverpagecont{\review@coverfile}
  \fi
\fi

\if@tate
  \def\@cite#1{\tatechuyoko{[#1]}}
  \def\@biblabel#1{\tatechuyoko{[#1]}}
\fi

\patchcmd{\addcontentsline}{\thepage}{\tatechuyoko{\thepage}}{}{}

\makeatletter

% titlepage
\ifdefined\review@titlepage
  \ifthenelse{\isundefined{\review@titlefile}}{%
    \def\reviewtitlepagecont{%
      \if@tate% 縦書き大扉
        \begin{titlepage}
        \thispagestyle{empty}
        %\niceframe{%
          \begin{minipage}<y>{\textheight}
            \begin{center}
              \mbox{}%
              \vskip5\zw
              \reviewtitlefont%
              {\Huge\review@booktitlename\par}%
              \ifdefined\review@subtitlename
                \vskip 1em%
                {\Large\review@subtitlename\par}%
              \fi
              \vskip 15em%
              {\huge
                \lineskip .75em
                \begin{tabular}[t]{p{\textwidth}}%
                  \centering\review@titlepageauthors
                \end{tabular}\par}%
            \end{center}
          \end{minipage}
          \hfill
          \begin{minipage}<y>{\textheight}
            \begin{center}
              \reviewtitlefont%
              {\large\review@date \review@intn@edition%
                \hspace{2\zw}%
                \review@intn@publishedby\par}%
              \vskip4\zw\mbox{}
            \end{center}
          \end{minipage}
        %}
        \end{titlepage}
        \clearpage
      \else% 横書き大扉
        \begin{titlepage}
        \thispagestyle{empty}
        \niceframe{%
        \begin{center}%
        \mbox{}%
        \vskip5\zw
        \reviewtitlefont%
        {\Huge\review@booktitlename\par}%
        \ifdefined\review@subtitlename
          \vskip 1em%
          {\Large\review@subtitlename\par}%
        \fi
        \vskip 15em%
        {\huge
        \lineskip .75em
        \begin{tabular}[t]{p{\textwidth}}%
        \centering\review@titlepageauthors
        \end{tabular}\par}%
        \vfill
        {\large\review@date \review@intn@edition%
          \hspace{2\zw}%
          \review@intn@publishedby\par}%
        \vskip4\zw\mbox{}
        \end{center}%
        }
        \end{titlepage}\clearpage
      \fi
    }
  }{%
    \def\reviewtitlepagecont{\review@titlefile}
  }
\fi

% colophon
\ifdefined\review@colophon
  \ifthenelse{\isundefined{\review@colophonfile}}{%
    \def\reviewcolophonpagecont{%
      \reviewcolophon
      \if@tate% 縦書き奥付
        \thispagestyle{empty}
        \hfill
        \begin{minipage}<y>{\textheight}
          {\noindent\reviewtitlefont\Large\review@booktitlename}\\
          \ifdefined\review@subtitlename
            {\noindent\reviewtitlefont\large\review@subtitlename} \\
          \fi
          \rule[8pt]{\textwidth}{1pt} \\
          {\noindent\review@pubhistories}
          \vspace{.5\Cvs}

          \begin{tabularx}{\dimexpr\textwidth-0.5em}{lX}
            \review@colophonnames
          \end{tabularx}%
          　\\
          \rule[0pt]{\textwidth}{1pt} \\
          \ifdefined\review@rights
            \review@rights
          \fi
        \end{minipage}
      \else% 横書き奥付
        \thispagestyle{empty}
        \vspace*{\fill}
        {\noindent\reviewtitlefont\Large\review@booktitlename}\\
        \ifdefined\review@subtitlename
          {\noindent\reviewtitlefont\large\review@subtitlename} \\
        \fi
        \rule[8pt]{\textwidth}{1pt} \\
        {\noindent\review@pubhistories}

        \begin{tabularx}{\dimexpr\textwidth-0.5em}{lX}
          \review@colophonnames
        \end{tabularx}%
        　\\
        \rule[0pt]{\textwidth}{1pt} \\
        \ifdefined\review@rights
          \review@rights
        \fi
      \fi
    }%
  }{%
    \def\reviewcolophonpagecont{\review@colophonfile}
  }
\fi

\newcolumntype{L}[1]{>{\raggedright\let\newline\\\arraybackslash\hspace{0pt}}p{#1}}
\newcolumntype{C}[1]{>{\centering\let\newline\\\arraybackslash\hspace{0pt}}p{#1}}
\newcolumntype{R}[1]{>{\raggedleft\let\newline\\\arraybackslash\hspace{0pt}}p{#1}}

\ifx\jlreq@theindex@savedpagestyle\@undefined\else\expandafter\pagestyle\expandafter{\jlreq@theindex@savedpagestyle}\fi
\let\jlreq@theindex@savedpagestyle\@undefined
\ifjlreq@resttate\tate\fi
\jlreq@oldfontcommand@disable

%. デフォルト設定
%.. 見出し
\if@tate
  \renewcommand{\thepart}{\jlreq@Kanji{part}}
  \str_if_eq:VnF \jlreq@article@type { article }{\renewcommand{\thechapter}{\jlreq@Kanji{chapter}}}
  \renewcommand{\thesection}{\tatechuyoko*{\@arabic\c@section}}
  \renewcommand{\thesubsection}{\tatechuyoko*{\@alph\c@subsection}}
  \renewcommand{\thesubsubsection}{\tatechuyoko*{\@arabic\c@subsubsection}}
  \renewcommand{\theparagraph}{(\tatechuyoko*{\@arabic\c@paragraph})}
  \renewcommand{\thesubparagraph}{(\tatechuyoko*{\@arabic\c@subparagraph})}

  \str_if_eq:VnTF \jlreq@article@type { article } {
    \NewBlockHeading{part}{0}{font={\jlreq@keepbaselineskip{\LARGE}},indent=4\jlreq@zw,lines=4,after_label_space=1\jlreq@zw,second_heading_text_indent={-1\jlreq@zw,1\jlreq@zw},subtitle_font={\jlreq@keepbaselineskip{\large}}}
    \if@twoside\ModifyHeading{part}{allowbreak_if_evenpage=true}\fi
  }
  {% book, report
    \NewTobiraHeading{part}{-1}{label_format={第\thepart 部\hspace*{1\jlreq@zw}},format={\null\vfill {\Huge\hspace*{2\jlreq@zw}#1#2}\vspace*{2\jlreq@gol}}}
    \NewBlockHeading{chapter}{0}{indent=2\jlreq@zw,lines=6,label_format={第\thechapter 章},font={\huge},after_label_space=1\jlreq@zw,second_heading_text_indent={-1\jlreq@zw,1\jlreq@zw},subtitle_font={\jlreq@keepbaselineskip{\Large}}}
    \if@twoside\ModifyHeading{chapter}{allowbreak_if_evenpage=true}\fi
    \renewcommand{\thechapter}{\jlreq@Kanji{chapter}}
  }
  \NewBlockHeading{section}{1}{font={\jlreq@keepbaselineskip{\Large}},indent=6\jlreq@zw,lines=3,after_label_space=1\jlreq@zw,second_heading_text_indent={-1\jlreq@zw,1\jlreq@zw},subtitle_font={\jlreq@keepbaselineskip{\normalsize}}}
  \if@twoside\ModifyHeading{section}{allowbreak_if_evenpage=true}\fi
  \NewBlockHeading{subsection}{2}{font={\jlreq@keepbaselineskip{\large}},indent=8\jlreq@zw,lines=2,after_label_space=1\jlreq@zw,second_heading_text_indent={-1\jlreq@zw,1\jlreq@zw},subtitle_font={\jlreq@keepbaselineskip{\small}}}
  \if@twoside\ModifyHeading{subsection}{allowbreak_if_evenpage=true}\fi
  \NewBlockHeading{subsubsection}{3}{font={\jlreq@keepbaselineskip{\normalsize}},indent=10\jlreq@zw,lines=1,before_lines=1,subtitle_break=false,after_label_space=1\jlreq@zw,second_heading_text_indent={-1\jlreq@zw,1\jlreq@zw},,subtitle_font={\jlreq@keepbaselineskip{\scriptsize}}}
  \if@twoside\ModifyHeading{subsubsection}{allowbreak_if_evenpage=true}\fi
  \NewRuninHeading{paragraph}{4}{font={\jlreq@keepbaselineskip{\normalsize}\sffamily\gtfamily\bfseries}}
  \NewRuninHeading{subparagraph}{5}{font={\jlreq@keepbaselineskip{\normalsize}\sffamily\gtfamily\bfseries},indent=1\jlreq@zw}
\else% yoko
  \renewcommand{\thepart}{\Roman{part}}
  \renewcommand{\thesubsection}{\thesection .\arabic{subsection}}
  \renewcommand{\thesubsubsection}{\thesubsection .\arabic{subsubsection}}
  \renewcommand{\theparagraph}{\thesubsubsection .\arabic{paragraph}}
  \renewcommand{\thesubparagraph}{\theparagraph .\arabic{subparagraph}}
  \str_if_eq:VnTF \jlreq@article@type { article } {
\def\X{}
    \NewBlockHeading{part}{0}{font={\jlreq@keepbaselineskip{\LARGE\sffamily\gtfamily\bfseries}},label_format={第\thepart 部},lines=4,after_label_space=1\jlreq@zw,second_heading_text_indent={-1\jlreq@zw,1\jlreq@zw},subtitle_font={\jlreq@keepbaselineskip{\large}}}
    \renewcommand{\thesection}{\arabic{section}}
  }{% book, report
    \NewTobiraHeading{part}{-1}{label_format={第\thepart 部\hspace*{1\jlreq@gol}},format={\null\vfil {\Huge\sffamily\gtfamily\bfseries #1#2}\vfil}}
    \NewBlockHeading{chapter}{0}{%
      font={\jlreq@keepbaselineskip{\huge\sffamily\gtfamily\bfseries}},
      label_format={第\thechapter 章},
      lines=5,after_label_space=1\jlreq@zw,second_heading_text_indent={-1\jlreq@zw,1\jlreq@zw},
      subtitle_font={\jlreq@keepbaselineskip{\Large}}}
    \renewcommand{\thechapter}{\arabic{chapter}}
    \renewcommand{\thesection}{\thechapter.\arabic{section}}
  }
  \NewBlockHeading{section}{1}{font={\jlreq@keepbaselineskip{\Large\sffamily\gtfamily\bfseries}},lines=3,after_label_space=1\jlreq@zw,second_heading_text_indent={-1\jlreq@zw,1\jlreq@zw},subtitle_font={\jlreq@keepbaselineskip{\normalsize}}}
  \NewBlockHeading{subsection}{2}{font={\jlreq@keepbaselineskip{\large\sffamily\gtfamily\bfseries}},lines=2,after_label_space=1\jlreq@zw,second_heading_text_indent={-1\jlreq@zw,1\jlreq@zw},subtitle_font={\jlreq@keepbaselineskip{\small}}}
  \NewBlockHeading{subsubsection}{3}{font={\jlreq@keepbaselineskip{\normalsize\sffamily\gtfamily\bfseries}},lines=1,before_lines=1,subtitle_break=false,after_label_space=1\jlreq@zw,second_heading_text_indent={-1\jlreq@zw,1\jlreq@zw},subtitle_font={\jlreq@keepbaselineskip{\scriptsize}}}
  \NewRuninHeading{paragraph}{4}{font={\jlreq@keepbaselineskip{\normalsize\sffamily\gtfamily\bfseries}},indent=1\jlreq@zw}
  \NewRuninHeading{subparagraph}{5}{font={\jlreq@keepbaselineskip{\normalsize\sffamily\gtfamily\bfseries}},indent=2\jlreq@zw}
\fi

\makeatother